--[[
-- ZMaxPlayerNetLoad = 2000000
-- ZMaxPlayerNetLoad = 90000
ZMaxPlayerNetLoad = 9000
ZPlayerNetLoadClearCD = 1
ZTotalNetLoadDebugEnabled = false

net.Old_Incoming = net.Old_Incoming or net.Incoming

function net.Incoming(len, ply)
	ply.ZLastNetClearTime = ply.ZLastNetClearTime or CurTime()
	ply.ZNetLoad = (ply.ZNetLoad or 0) + len
	
	if(ply.ZLastNetClearTime + ZPlayerNetLoadClearCD <= CurTime())then
		ply.ZLastNetClearTime = CurTime()
		ply.ZNetLoad = 0
	end
	
	local max_load = ZMaxPlayerNetLoad
	
	if(ply.ZNetLoad_Max)then
		max_load = ply.ZNetLoad_Max
	end
	
	if(!ply.ZNetLoad_Immunity and ply.ZNetLoad > max_load)then
		-- print(ply:Nick() .. " sending too many nets, stop reciving!") return 
		ply:Kick("Reserved slot, sorry")
		
		return
	end
	
	if(ZTotalNetLoadDebugEnabled)then
		ZPlayerLoadAll = (ZPlayerLoadAll or 0) + len
		
		if(!ZLastNetLoadAllClearTime or (ZLastNetLoadAllClearTime + ZPlayerNetLoadClearCD) <= CurTime())then
			ZLastNetLoadAllClearTime = CurTime()
			
			print("Total net load in " .. ZPlayerNetLoadClearCD .. " seconds: " .. ZPlayerLoadAll)
			
			ZPlayerLoadAll = 0
		end
	end
	
	return net.Old_Incoming(len, ply)
end
]]

local SysTime = SysTime
local RealTime = RealTime
local net_limit = 1200
local net_block_time = 3

local function punish(ply, sec)
	ply.net_incoming_suppress = SysTime() + sec
	print("[net] блокируем дальнейшие сообщения " .. ply:Name() .. " на " .. sec .. " сек.")
end

local xpcall, lower = xpcall, string.lower

function net.Incoming(length, ply)
	if(!ply.ZNetLoad_Immunity and !ply.ZNetLoad_Max)then
		if (ply.net_incoming_suppress or 0) > SysTime() then
			return
		end
	end

	do
		local i = net.ReadHeader()
		local id = util.NetworkIDToString(i)

		if not id then
			return
		end

		if id == "simfphys_request_ppdata" then
			return
		end

		if id ~= "PP.Network" then
			ply.net_incoming_rate_count = (ply.net_incoming_rate_count or 0) + 1

			if ((ply.net_incoming_rate_next_check or 0) < RealTime()) then
				if (ply.net_incoming_rate_count > net_limit) then
					MsgC(Color(255, 0, 0), "[net] " .. ply:Name() .. " посылает больше " .. net_limit .. " нетворков в секунду; последний NET: " .. id .. "\n")
					punish(ply, net_block_time)
				end

				ply.net_incoming_rate_count = 0
				ply.net_incoming_rate_next_check = RealTime() + 1
			end
		end

		local func = net.Receivers[lower(id)]

		if func then
			local ok = xpcall(
				func,
				function(msg)
					ErrorNoHalt(debug.traceback(("net message %q (%s) from %s (%s) errored:"):format(id, string.NiceSize(length), tostring(ply), ply:SteamID())))
				end,
				length - 16,
				ply
			)

			if not ok then
				punish(ply, 1)
			end
		end
	end
end